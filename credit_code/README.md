# credit_code 目录说明

本目录聚焦信用风险建模的训练与评估，涵盖多种模型训练脚本、公共工具函数及自动化调度脚本。所有代码默认读取 `../data/` 目录中的 Excel/CSV 数据集，并把预测结果与可视化输出写入 `../outputs/`。

## 文件逐一解析

### `common_utils.py`
- **核心功能**：集中实现列名标准化、业务域特征构造、特征类型划分、KS 统计量、最佳阈值搜索等通用函数。
- **运行原理**：
  - `normalize_columns` 统一列名的小写化与去空格，方便跨表对齐。
  - `add_business_features` 基于额度、逾期等字段派生信用使用率、贷款收入比、风险暴露指数、最近行为倒数特征等，捕捉业务经验信号。
  - `split_feature_columns` 自动区分数值/类别特征，给建模管道提供列索引。
  - `evaluate_and_plot` 计算 AUC/AP/KS、自动绘制 ROC/PR/KS 曲线，并导出混淆矩阵与分类报告 JSON，便于训练结束后的统一留档。
- **协同关系**：虽未被其他脚本直接导入，但其函数与各模型脚本中的自定义函数保持一致，可作为未来代码去重的公共库。

### `train_logistic.py`
- **核心功能**：基于逻辑回归构建基线分类模型并产出概率提交文件。
- **运行原理**：
  - 读取训练、测试数据后调用本地定义的标准化与业务特征增强函数（实现与 `common_utils` 类似）。
  - 通过 `ColumnTransformer` 将数值特征进行中位数填补+标准化，类别特征做众数填补+独热编码，并使用 `Pipeline` 串联到 `LogisticRegression`（liblinear 求解器，类权重平衡）。
  - 分层划分验证集，计算 AUC/AP/KS 指标并打印。
  - 对测试集输出概率到 `outputs/submission_logistic_regression.csv`，并绘制前 20 个特征（系数绝对值）重要性条形图。
- **协同关系**：生成的 CSV 与图表供 `run_all.py` 后续融合与对比使用。

### `train_extratrees.py`
- **核心功能**：训练 Extra Trees 集成模型，强调非线性特征交互的拟合能力。
- **运行原理**：
  - 前处理流程与逻辑回归脚本保持一致，以统一数据口径。
  - 模型端使用 `ExtraTreesClassifier`（400 棵树、`balanced_subsample` 类权重、全并行训练），并输出验证集概率。
  - 保存预测至 `outputs/submission_extra_trees.csv`，按模型的 `feature_importances_` 生成重要性图。
- **协同关系**：与其他模型产生一致格式的提交文件，便于融合；共享的特征工程逻辑确保不同模型输入一致。

### `train_xgboost.py`
- **核心功能**：训练梯度提升树模型 XGBoost，适合处理复杂非线性和稀疏特征。
- **运行原理**：
  - 与其他脚本统一的特征工程 / 预处理管线。
  - 设置 `scale_pos_weight = negatives/positives` 缓和样本不平衡，使用 500 颗树、学习率 0.05、`subsample`/`colsample_bytree`=0.8 控制过拟合。
  - 产出验证指标、`outputs/submission_xgboost.csv` 以及基于模型内置重要性（Gain）的 Top-20 可视化。
- **协同关系**：在 `run_all.py` 中常作为提升表现的关键模型，与其他提交文件共同参与加权融合。

### `train_linear_regression.py`
- **核心功能**：以线性回归的回归输出作为概率估计，提供一个简单但可对比的基线。
- **运行原理**：
  - 延续统一的特征构造与 `ColumnTransformer` 预处理思路。
  - 使用 `LinearRegression` 拟合连续标签，再将预测压缩到 `[0,1]` 区间。
  - 为计算分类指标，脚本把验证集真实值阈值化（>=0.5 视为 1），得到 AUC/AP/KS。
  - 结果写入 `outputs/submission_linear_regression.csv` 并输出系数绝对值作为特征重要性。
- **协同关系**：虽然预测能力有限，但生成的标准格式输出能参与融合，帮助观察线性基线与非线性模型的差距。

### `run_all.py`
- **核心功能**：统一调度各模型脚本、收集指标、自动选择表现最佳的模型进行融合并输出报告。
- **运行原理**：
  - 依次调用 `train_*.py`，捕获标准输出文本，并用正则提取每个模型的 AUC/AP/KS。
  - 从 `outputs/` 加载各模型生成的提交 CSV，验证是否读取成功。
  - 自动挑选 AUC 最高的两个模型，根据其 AUC 权重做概率加权融合；若缺少足够模型则回退到全部可用预测。
  - 与训练集标签对齐、计算融合模型指标、绘制 ROC 曲线，最终写出融合提交 (`submission_ensemble.csv`)。
  - 汇总单模与融合指标到 `model_comparison.csv` 并绘制条形对比图，便于快速评估实验结果。
- **协同关系**：扮演编排中心，需要依赖各 `train_*.py` 事先生成的预测文件与指标日志，输出的融合结果及可视化反哺建模迭代。

## 模块协同关系
- **数据路径一致**：所有脚本默认从 `../data` 中读取训练/测试/样例文件，保证数据源统一。
- **特征工程对齐**：虽然每个训练脚本内嵌特征处理函数，但逻辑一致，确保各模型的输入特征空间完全一致；`common_utils.py` 可作为未来抽象的单一来源。
- **输出约定统一**：每个模型脚本都会在 `../outputs` 下生成同结构的 `submission_*.csv` 与可视化图，这些是 `run_all.py` 自动解析的前提。
- **指标闭环**：训练脚本负责打印核心指标；`run_all.py` 负责汇总与可视化，还能基于训练集切片验证融合方案，从而形成一条从训练到评估再到融合输出的闭环流水线。

## 总结
本目录体现了“多模型训练 + 自动化融合评估”的工作流：`train_*.py` 各自完成模型训练和预测产出，同时维持统一的数据与特征处理方式；`run_all.py` 在此基础上调度、挖掘指标并完成加权融合；`common_utils.py` 则沉淀了可复用的特征工程与评估函数，方便未来在脚本间复用或扩展。整体结构清晰，便于后续增加新模型脚本或抽象公共组件以减少重复代码。
